version: '3.9'

services:
  # Banco de dados MySQL
  db:
    image: mysql:8.0
    container_name: sospets_mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_NAME:-sos_pets}
      MYSQL_USER: ${DB_USER:-sos_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-sos_password}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_password}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sospets_network

  # Redis (cache e broker do Celery)
  redis:
    image: redis:7-alpine
    container_name: sospets_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sospets_network

  # Backend Django
  web:
    build:
      context: ./backend/backend
      dockerfile: Dockerfile
    container_name: sospets_web
    restart: unless-stopped
    command: python manage.py runserver 0.0.0.0:8000
    environment:
      # Django
      DJANGO_ENV: ${DJANGO_ENV:-dev}
      SECRET_KEY: ${SECRET_KEY:-unsafe-dev-key-change-in-production}
      DEBUG: ${DEBUG:-True}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1,web}
      
      # Database
      DB_ENGINE: mysql
      DB_NAME: ${DB_NAME:-sos_pets}
      DB_USER: ${DB_USER:-sos_user}
      DB_PASSWORD: ${DB_PASSWORD:-sos_password}
      DB_HOST: db
      DB_PORT: 3306
      
      # DRF
      PAGE_SIZE: ${PAGE_SIZE:-12}
      
      # CORS
      CORS_ALLOW_ALL_ORIGINS: ${CORS_ALLOW_ALL_ORIGINS:-True}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
      
      # JWT
      ACCESS_MINUTES: ${ACCESS_MINUTES:-15}
      REFRESH_DAYS: ${REFRESH_DAYS:-7}
      
      # Superuser (opcional - para criar automaticamente)
      DJANGO_SUPERUSER_USERNAME: ${DJANGO_SUPERUSER_USERNAME:-}
      DJANGO_SUPERUSER_EMAIL: ${DJANGO_SUPERUSER_EMAIL:-}
      DJANGO_SUPERUSER_PASSWORD: ${DJANGO_SUPERUSER_PASSWORD:-}
    volumes:
      - ./backend/backend:/app
      - media_files:/app/media
      - static_files:/app/staticfiles
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/schema/').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - sospets_network

  # Celery Worker (para tarefas ass√≠ncronas - futuro)
  # celery:
  #   build:
  #     context: ./backend/backend
  #     dockerfile: Dockerfile
  #   container_name: sospets_celery
  #   restart: unless-stopped
  #   command: celery -A backend worker -l info
  #   environment:
  #     - DJANGO_ENV=${DJANGO_ENV:-dev}
  #     - CELERY_BROKER_URL=redis://redis:6379/0
  #     - CELERY_RESULT_BACKEND=redis://redis:6379/0
  #   volumes:
  #     - ./backend/backend:/app
  #   depends_on:
  #     - db
  #     - redis
  #   networks:
  #     - sospets_network

volumes:
  mysql_data:
    name: sospets_mysql_data
  redis_data:
    name: sospets_redis_data
  media_files:
    name: sospets_media
  static_files:
    name: sospets_static

networks:
  sospets_network:
    name: sospets_network
    driver: bridge
