{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>In√≠cio - SOS Pets</title>
        <link rel="icon" type="image/png" href="{% static 'Estetica_site/Logo.png' %}">
    <link rel="stylesheet" href="{% static 'style.css' %}">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    </head>
<body>

    <header>
    <a href="/" class="header-logo-link">
        <i class="fas fa-paw"></i>
        <span class="logo-text">S.O.S Pets</span>
    </a>

    <nav>
        <a href="/adocao/"><i class="fas fa-heart"></i><span>Ado√ß√£o</span></a>
        <a href="/arrecadacao/"><i class="fas fa-hand-holding-heart"></i><span>Arrecada√ß√£o</span></a>
        <a href="/denuncia/"><i class="fas fa-bullhorn"></i><span>Den√∫ncia</span></a>
        <a href="/animais-perdidos/"><i class="fas fa-search"></i><span>Pets Perdidos</span></a>
        <a href="/contato/"><i class="fas fa-envelope"></i><span>Contato</span></a>
        <div class="nav-user-area"></div>
    </nav>
</header>

    <main>
        <section class="filter-panel">
    <form class="new-filter-form">
        <div class="filter-row">
            <select name="especie" aria-label="Esp√©cie">
                <option value="">Todas as Esp√©cies</option>
                <option value="cao">C√£es</option>
                <option value="gato">Gatos</option>
            </select>
            <select name="porte" aria-label="Porte">
                <option value="">Todos os Portes</option>
                <option value="pequeno">Pequeno</option>
                <option value="medio">M√©dio</option>
                <option value="grande">Grande</option>
            </select>
            <select id="estado-select" name="estado" aria-label="Estado">
                <option value="">Todos os Estados</option>
                </select>
            <select id="cidade-select" name="cidade" aria-label="Cidade" disabled>
                <option value="">Escolha um estado</option>
            </select>
        </div>
        <div class="filter-row">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" name="nome-pet" placeholder="Busque por um nome espec√≠fico...">
            </div>
            <button type="submit" class="btn-submit">Buscar</button>
        </div>
    </form>
</section>

<div class="page-title">
    <h2>Conhe√ßa seu novo melhor amigo!</h2>
    <button id="btn-cadastrar-pet" class="btn-cadastrar-pet" style="display: none;">
        <i class="fas fa-plus-circle"></i> Cadastrar Pet para Ado√ß√£o
    </button>
</div>

<!-- Modal de Cadastro de Pet -->
<div id="modal-cadastrar-pet" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-cadastro-pet">
        <div class="modal-header">
            <h3><i class="fas fa-paw"></i> Cadastrar Pet para Ado√ß√£o</h3>
            <button class="modal-close" onclick="fecharModalCadastro()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="form-cadastrar-pet" enctype="multipart/form-data">
            <p style="color: #666; margin-bottom: 25px; font-size: 0.95rem;">
                <i class="fas fa-info-circle" style="color: #4CAF50;"></i>
                Preencha os dados do pet que voc√™ deseja disponibilizar para ado√ß√£o. Ap√≥s o envio, sua solicita√ß√£o ser√° analisada por nossa equipe.
            </p>
            <div class="form-row">
                <div class="form-group">
                    <label for="pet-nome"><i class="fas fa-tag"></i> Nome do Pet *</label>
                    <input type="text" id="pet-nome" name="nome" autocomplete="off" required placeholder="Ex: Tot√≥">
                </div>
                <div class="form-group">
                    <label for="pet-especie"><i class="fas fa-paw"></i> Esp√©cie *</label>
                    <select id="pet-especie" name="especie" autocomplete="off" required>
                        <option value="">Selecione...</option>
                        <option value="cachorro">üêï Cachorro</option>
                        <option value="gato">üêà Gato</option>
                        <option value="outro">üêæ Outro</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" id="grupo-especie-outro" style="display: none; margin-bottom: 20px;">
                <label for="pet-especie-outro"><i class="fas fa-edit"></i> Qual esp√©cie? *</label>
                <input type="text" id="pet-especie-outro" name="especie_outro" autocomplete="off" placeholder="Ex: Coelho, P√°ssaro, Hamster...">
                <small><i class="fas fa-info-circle"></i> Digite o nome da esp√©cie do seu pet</small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="pet-porte"><i class="fas fa-ruler-vertical"></i> Porte *</label>
                    <select id="pet-porte" name="porte" autocomplete="off" required>
                        <option value="">Selecione...</option>
                        <option value="pequeno">Pequeno (at√© 10kg)</option>
                        <option value="medio">M√©dio (10kg a 25kg)</option>
                        <option value="grande">Grande (acima de 25kg)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pet-sexo"><i class="fas fa-venus-mars"></i> Sexo *</label>
                    <select id="pet-sexo" name="sexo" autocomplete="off" required>
                        <option value="">Selecione...</option>
                        <option value="M">üîµ Macho</option>
                        <option value="F">üî¥ F√™mea</option>
                        <option value="N">‚ùì N√£o informar</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="pet-cor"><i class="fas fa-palette"></i> Cor *</label>
                    <select id="pet-cor" name="cor" autocomplete="off" required>
                        <option value="">Selecione...</option>
                        <option value="Preto">‚ö´ Preto</option>
                        <option value="Branco">‚ö™ Branco</option>
                        <option value="Marrom">üü§ Marrom</option>
                        <option value="Caramelo">üü† Caramelo</option>
                        <option value="Cinza">‚ö´ Cinza</option>
                        <option value="Mesclado">üîò Mesclado</option>
                        <option value="Tigrado">üêØ Tigrado</option>
                        <option value="Malhado">üêÑ Malhado</option>
                        <option value="Outro">‚úèÔ∏è Outra cor</option>
                    </select>
                </div>
                <div class="form-group" id="grupo-cor-outro" style="display: none;">
                    <label for="pet-cor-outro"><i class="fas fa-edit"></i> Qual cor?</label>
                    <input type="text" id="pet-cor-outro" name="cor_outro" autocomplete="off" placeholder="Digite a cor do pet...">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="pet-imagem"><i class="fas fa-camera"></i> Foto do Pet *</label>
                    <input type="file" id="pet-imagem" name="imagem_principal" accept="image/*" autocomplete="off" required>
                    <small><i class="fas fa-info-circle"></i> Formatos aceitos: JPG, PNG, GIF</small>
                </div>
                <div class="form-group"></div>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="pet-descricao"><i class="fas fa-align-left"></i> Descri√ß√£o do Pet *</label>
                <textarea id="pet-descricao" name="descricao" rows="4" autocomplete="off" required placeholder="Conte um pouco sobre o temperamento, comportamento, cuidados especiais, hist√≥rico..."></textarea>
                <small><i class="fas fa-lightbulb"></i> Quanto mais detalhes, melhor para encontrar um lar adequado!</small>
            </div>
            
            <h4 style="color: #4CAF50; margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">
                <i class="fas fa-map-marker-alt"></i> Localiza√ß√£o
            </h4>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="pet-estado"><i class="fas fa-map"></i> Estado *</label>
                    <select id="pet-estado" name="estado" autocomplete="address-level1" required>
                        <option value="">Selecione o estado...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pet-cidade"><i class="fas fa-city"></i> Cidade *</label>
                    <select id="pet-cidade" name="cidade" autocomplete="address-level2" required disabled>
                        <option value="">Selecione o estado primeiro...</option>
                    </select>
                    <small style="display:none;" id="loading-cidades"><i class="fas fa-spinner fa-spin"></i> Carregando cidades...</small>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="pet-endereco"><i class="fas fa-home"></i> Endere√ßo Completo *</label>
                <input type="text" id="pet-endereco" name="endereco_completo" autocomplete="street-address" required placeholder="Rua, n√∫mero, bairro...">
                <small style="color: #f39c12;"><i class="fas fa-lock"></i> Este endere√ßo s√≥ ser√° compartilhado ap√≥s aprova√ß√£o da ado√ß√£o.</small>
            </div>
            
            <h4 style="color: #4CAF50; margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">
                <i class="fas fa-phone"></i> Informa√ß√µes de Contato
            </h4>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="pet-telefone"><i class="fas fa-mobile-alt"></i> Telefone/WhatsApp *</label>
                    <input type="tel" id="pet-telefone" name="telefone" autocomplete="tel" required placeholder="(00) 00000-0000">
                </div>
                <div class="form-group">
                    <label for="pet-email"><i class="fas fa-envelope"></i> E-mail *</label>
                    <input type="email" id="pet-email" name="email" autocomplete="email" required placeholder="seu@email.com">
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="fecharModalCadastro()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="submit" class="btn-submit">
                    <i class="fas fa-check"></i> Cadastrar Pet
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Detalhes do Pet -->
<div id="modal-detalhes-pet" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-detalhes-pet">
        <button class="modal-close" onclick="fecharModalDetalhes()">
            <i class="fas fa-times"></i>
        </button>
        <div id="conteudo-modal-pet">
            <!-- Conte√∫do ser√° preenchido dinamicamente -->
        </div>
    </div>
</div>

<div class="galeria-adocao">

    <div class="animal-card" data-especie="cao" data-nome="abelly" data-sexo="femea" data-porte="pequeno" data-estado="SP" data-cidade="sao-paulo">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/1805164/pexels-photo-1805164.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Cachorro Abelly">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Abelly</h4>
                <div class="card-icons"><i class="fas fa-venus" title="F√™mea"></i></div>
            </div>
            <p class="location">S√£o Paulo, SP</p>
            <div class="details-hidden">
                 <span>C√£o</span><span>Pequeno</span>
            </div>
            <a href="formulario-adocao.html?pet=Abelly" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="gato" data-nome="aglaia" data-sexo="femea" data-porte="pequeno" data-estado="RJ" data-cidade="rio-de-janeiro">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/208773/pexels-photo-208773.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Gato Aglaia">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Aglaia</h4>
                <div class="card-icons"><i class="fas fa-venus" title="F√™mea"></i></div>
            </div>
            <p class="location">Rio de Janeiro, RJ</p>
            <div class="details-hidden">
                 <span>Gato</span><span>Pequeno</span>
            </div>
            <a href="formulario-adocao.html?pet=Aglaia" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="cao" data-nome="alordy" data-sexo="macho" data-porte="medio" data-estado="MG" data-cidade="belo-horizonte">
        <div class="card-image-container">
            <div class="galeria-adocao" id="galeria-adocao">
                <div id="no-results-message" style="display: none; grid-column: 1 / -1; text-align: center;">
                    <h3>Nenhum animal encontrado</h3>
                    <p>Tente ajustar os filtros para encontrar mais amigos.</p>
                </div>
            </div>
            <div class="details-hidden">
                 <span>C√£o</span><span>M√©dio</span>
            </div>
            <a href="formulario-adocao.html?pet=Alordy" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="cao" data-nome="apolo" data-sexo="macho" data-porte="grande" data-estado="SP" data-cidade="sao-joaquim-da-barra">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/3726315/pexels-photo-3726315.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Cachorro Apolo">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Apolo</h4>
                <div class="card-icons"><i class="fas fa-mars" title="Macho"></i></div>
            </div>
            <p class="location">S√£o Joaquim da Barra, SP</p>
            <div class="details-hidden">
                 <span>C√£o</span><span>Grande</span>
            </div>
            <a href="formulario-adocao.html?pet=Apolo" class="card-button">Quero adotar</a>
        </div>
    </div>

    <div class="animal-card" data-especie="cao" data-nome="abelly" data-sexo="femea" data-porte="pequeno" data-estado="SP" data-cidade="sao-paulo">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/1805164/pexels-photo-1805164.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Cachorro Abelly">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Abelly</h4>
                <div class="card-icons"><i class="fas fa-venus" title="F√™mea"></i></div>
            </div>
            <p class="location">S√£o Paulo, SP</p>
            <div class="details-hidden">
                 <span>C√£o</span><span>Pequeno</span>
            </div>
            <a href="formulario-adocao.html?pet=Abelly" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="gato" data-nome="aglaia" data-sexo="femea" data-porte="pequeno" data-estado="RJ" data-cidade="rio-de-janeiro">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/208773/pexels-photo-208773.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Gato Aglaia">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Aglaia</h4>
                <div class="card-icons"><i class="fas fa-venus" title="F√™mea"></i></div>
            </div>
            <p class="location">Rio de Janeiro, RJ</p>
            <div class="details-hidden">
                 <span>Gato</span><span>Pequeno</span>
            </div>
            <a href="formulario-adocao.html?pet=Aglaia" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="cao" data-nome="alordy" data-sexo="macho" data-porte="medio" data-estado="MG" data-cidade="belo-horizonte">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/57497/pexels-photo-57497.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Cachorro Alordy">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Alordy</h4>
                <div class="card-icons"><i class="fas fa-mars" title="Macho"></i></div>
            </div>
            <p class="location">Belo Horizonte, MG</p>
            <div class="details-hidden">
                 <span>C√£o</span><span>M√©dio</span>
            </div>
            <a href="formulario-adocao.html?pet=Alordy" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="cao" data-nome="apolo" data-sexo="macho" data-porte="grande" data-estado="SP" data-cidade="sao-joaquim-da-barra">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/3726315/pexels-photo-3726315.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Cachorro Apolo">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Apolo</h4>
                <div class="card-icons"><i class="fas fa-mars" title="Macho"></i></div>
            </div>
            <p class="location">S√£o Joaquim da Barra, SP</p>
            <div class="details-hidden">
                 <span>C√£o</span><span>Grande</span>
            </div>
            <a href="formulario-adocao.html?pet=Apolo" class="card-button">Quero adotar</a>
        </div>
    </div>

    <div class="animal-card" data-especie="cao" data-nome="abelly" data-sexo="femea" data-porte="pequeno" data-estado="SP" data-cidade="sao-paulo">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/1805164/pexels-photo-1805164.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Cachorro Abelly">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Abelly</h4>
                <div class="card-icons"><i class="fas fa-venus" title="F√™mea"></i></div>
            </div>
            <p class="location">S√£o Paulo, SP</p>
            <div class="details-hidden">
                 <span>C√£o</span><span>Pequeno</span>
            </div>
            <a href="formulario-adocao.html?pet=Abelly" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="gato" data-nome="aglaia" data-sexo="femea" data-porte="pequeno" data-estado="RJ" data-cidade="rio-de-janeiro">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/208773/pexels-photo-208773.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Gato Aglaia">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Aglaia</h4>
                <div class="card-icons"><i class="fas fa-venus" title="F√™mea"></i></div>
            </div>
            <p class="location">Rio de Janeiro, RJ</p>
            <div class="details-hidden">
                 <span>Gato</span><span>Pequeno</span>
            </div>
            <a href="formulario-adocao.html?pet=Aglaia" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="cao" data-nome="alordy" data-sexo="macho" data-porte="medio" data-estado="MG" data-cidade="belo-horizonte">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/57497/pexels-photo-57497.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Cachorro Alordy">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Alordy</h4>
                <div class="card-icons"><i class="fas fa-mars" title="Macho"></i></div>
            </div>
            <p class="location">Belo Horizonte, MG</p>
            <div class="details-hidden">
                 <span>C√£o</span><span>M√©dio</span>
            </div>
            <a href="formulario-adocao.html?pet=Alordy" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div class="animal-card" data-especie="cao" data-nome="apolo" data-sexo="macho" data-porte="grande" data-estado="SP" data-cidade="sao-joaquim-da-barra">
        <div class="card-image-container">
            <img src="https://images.pexels.com/photos/3726315/pexels-photo-3726315.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Cachorro Apolo">
        </div>
        <div class="card-content">
            <div class="card-header">
                <h4>Apolo</h4>
                <div class="card-icons"><i class="fas fa-mars" title="Macho"></i></div>
            </div>
            <p class="location">S√£o Joaquim da Barra, SP</p>
            <div class="details-hidden">
                 <span>C√£o</span><span>Grande</span>
            </div>
            <a href="formulario-adocao.html?pet=Apolo" class="card-button">Quero adotar</a>
        </div>
    </div>
    
    <div id="no-results-message" style="display: none; grid-column: 1 / -1; text-align: center;">
        <h3>Nenhum animal encontrado</h3>
        <p>Tente ajustar os filtros para encontrar mais amigos.</p>
    </div>

    </div>

    </main>
    
    <footer>
    <div class="footer-left">
        <img src="{% static 'Estetica_site/logo-sos-pets.png' %}" alt="Logo S.O.S Pets" class="footer-logo-img">
        <p class="copyright">¬© 2025 S.O.S Pets</p>
    </div>

    <div class="footer-center">
    <a href="/adocao/">Ado√ß√£o</a>
    <a href="/arrecadacao/">Arrecada√ß√£o</a>
    <a href="/contato/">Contato</a>
    </div>

    <div class="footer-right">
        <p>Siga-nos nas redes:</p>
        <div class="footer-social-icons">
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
        </div>
    </div>
</footer>
    <!-- Removido script.js legado para evitar conflitos, se necess√°rio usar funcionalidades globais converta para static -->
    <!-- <script src="{% static 'script.js' %}"></script> -->
    <script>
    (function(){
        const API_BASE = '/api/animais/';
        const form = document.querySelector('.new-filter-form');
        const galeria = document.getElementById('galeria-adocao');
        const noResults = document.getElementById('no-results-message');
        const estadoSelect = document.getElementById('estado-select');
        const cidadeSelect = document.getElementById('cidade-select');

        // Corrige markup legado: move galeria din√¢mica para dentro do cont√™iner principal e remove cards est√°ticos
        const outerGallery = document.querySelector('div.galeria-adocao');
        const innerGallery = document.getElementById('galeria-adocao');
        if (outerGallery && innerGallery && innerGallery.parentElement !== outerGallery){
            // Remove cards est√°ticos do cont√™iner externo
            outerGallery.innerHTML = '';
            outerGallery.appendChild(innerGallery);
        }
        if (outerGallery){
            outerGallery.querySelectorAll(':scope > .animal-card').forEach(el => el.remove());
        }

        // Estados BR b√°sicos (UF)
        const UFS = ['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO'];
        UFS.forEach(uf => {
            const opt = document.createElement('option');
            opt.value = uf; opt.textContent = uf;
            estadoSelect.appendChild(opt);
        });
        // Garante que os filtros iniciem "em branco"
        form.querySelector('[name="especie"]').value = '';
        form.querySelector('[name="porte"]').value = '';
        estadoSelect.value = '';
        cidadeSelect.disabled = true;
        cidadeSelect.innerHTML = '<option value="">Escolha um estado</option>';

        async function carregarCidadesPorUF(uf){
            cidadeSelect.disabled = true;
            cidadeSelect.innerHTML = '<option value="">Carregando...</option>';
            try{
                const url = `https://servicodados.ibge.gov.br/api/v1/localidades/estados/${encodeURIComponent(uf)}/municipios?orderBy=nome`;
                const res = await fetch(url);
                if(!res.ok) throw new Error('Falha ao carregar cidades');
                const lista = await res.json();
                cidadeSelect.innerHTML = '<option value="">Todas as Cidades</option>';
                for(const c of lista){
                    const opt = document.createElement('option');
                    opt.value = c.nome;
                    opt.textContent = c.nome;
                    cidadeSelect.appendChild(opt);
                }
            }catch(e){
                console.warn('Erro ao buscar cidades do IBGE:', e);
                cidadeSelect.innerHTML = '<option value="">Todas as Cidades</option>';
            }finally{
                cidadeSelect.disabled = !uf;
            }
        }

        estadoSelect.addEventListener('change', async () => {
            const uf = estadoSelect.value;
            if(uf){
                await carregarCidadesPorUF(uf);
            } else {
                cidadeSelect.disabled = true;
                cidadeSelect.innerHTML = '<option value="">Escolha um estado</option>';
            }
            // auto-aplicar filtro ao mudar UF
            applyFiltersFromForm();
        });

        function mapEspecieToTipo(especie){
            if(!especie) return '';
            return especie === 'cao' ? 'cachorro' : especie;
        }

        function sexoIcon(sexo){
            if(!sexo) return '';
            return sexo.toLowerCase() === 'femea' ? '<i class="fas fa-venus" title="F√™mea"></i>' : '<i class="fas fa-mars" title="Macho"></i>';
        }

        function tipoLabel(tipo){
            if(tipo === 'cachorro') return 'C√£o';
            if(tipo === 'gato') return 'Gato';
            return tipo || '';
        }

        function porteLabel(porte){
            if(!porte) return '';
            const map = { pequeno: 'Pequeno', medio: 'M√©dio', grande: 'Grande' };
            return map[porte] || porte;
        }

        function cardTemplate(animal){
            const img = animal.imagem_absolute || animal.imagem_url || 'https://placehold.co/400x300?text=SOS+Pets';
            const loc = [animal.cidade, animal.estado].filter(Boolean).join(', ');
            const sexo = sexoIcon(animal.sexo || '');
            const tipo = tipoLabel(animal.tipo);
            const porte = porteLabel(animal.porte);
            const detalhes = [tipo, porte].filter(Boolean).map(v => `<span>${v}</span>`).join('');
            
            // Se √© de usu√°rio, abre modal. Se √© da ONG, vai para formul√°rio antigo
            if(animal.origem === 'usuario'){
                return `
                <div class="animal-card" onclick="abrirModalDetalhes(${animal.id}, 'usuario')" style="cursor: pointer;">
                    <div class="card-image-container">
                        <img src="${img}" alt="${tipo} ${animal.nome}">
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h4>${animal.nome}</h4>
                            <div class="card-icons">${sexo}</div>
                        </div>
                        <p class="location">${loc}</p>
                        <div class="details-hidden">${detalhes}</div>
                        <button class="card-button" onclick="event.stopPropagation(); abrirModalDetalhes(${animal.id}, 'usuario')">
                            <i class="fas fa-info-circle"></i> Ver detalhes
                        </button>
                    </div>
                </div>`;
            } else {
                const href = `/formulario-adocao/?pet=${encodeURIComponent(animal.nome)}`;
                return `
                <div class="animal-card">
                    <div class="card-image-container">
                        <img src="${img}" alt="${tipo} ${animal.nome}">
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h4>${animal.nome}</h4>
                            <div class="card-icons">${sexo}</div>
                        </div>
                        <p class="location">${loc}</p>
                        <div class="details-hidden">${detalhes}</div>
                        <a href="${href}" class="card-button">Quero adotar</a>
                    </div>
                </div>`;
            }
        }

        async function fetchAnimais(params={}){
            try {
                // Busca animais da ONG (API original)
                const urlONG = new URL(API_BASE, window.location.origin);
                Object.entries(params).forEach(([k,v]) => { if(v) urlONG.searchParams.set(k, v); });
                const resONG = await fetch(urlONG.toString());
                const dataONG = resONG.ok ? await resONG.json() : [];
                // Trata resposta DRF paginada ou array direto
                const animaisONG = Array.isArray(dataONG) ? dataONG : (dataONG.results || []);
                
                // Busca animais cadastrados por usu√°rios (novos)
                const urlUsuarios = new URL('/api/animais-adocao/', window.location.origin);
                // Mapeia par√¢metros para a nova API
                if(params.tipo) urlUsuarios.searchParams.set('especie', params.tipo);
                if(params.porte) urlUsuarios.searchParams.set('porte', params.porte);
                if(params.estado) urlUsuarios.searchParams.set('estado', params.estado);
                if(params.cidade) urlUsuarios.searchParams.set('cidade', params.cidade);
                if(params.nome) urlUsuarios.searchParams.set('nome', params.nome);
                
                const resUsuarios = await fetch(urlUsuarios.toString());
                const dataUsuarios = resUsuarios.ok ? await resUsuarios.json() : [];
                // Trata resposta DRF paginada ou array direto
                const animaisUsuarios = Array.isArray(dataUsuarios) ? dataUsuarios : (dataUsuarios.results || []);
                
                // Combina e normaliza ambas as listas
                const todosAnimais = [
                    ...animaisONG.map(a => ({...a, origem: 'ong'})),
                    ...animaisUsuarios.map(a => ({
                        ...a,
                        origem: 'usuario',
                        // Normaliza campos para compatibilidade com template
                        tipo: a.especie,
                        imagem_absolute: a.imagem_principal_url
                    }))
                ];
                
                return todosAnimais;
            } catch(err) {
                console.error('Erro ao buscar animais:', err);
                return [];
            }
        }

        function renderLista(lista){
            // Remove tudo menos o noResults (mant√©m no DOM para reuso)
            ;[...galeria.querySelectorAll('.animal-card')].forEach(el => el.remove());
            if(!lista || lista.length === 0){
                noResults.style.display = 'block';
                return;
            }
            noResults.style.display = 'none';
            const html = lista.map(cardTemplate).join('');
            galeria.insertAdjacentHTML('afterbegin', html);
        }

        async function applyFiltersFromForm(ev){
            if(ev) ev.preventDefault();
            // Esconde placeholder antes da busca
            noResults.style.display = 'none';
            const fd = new FormData(form);
            const params = {
                tipo: mapEspecieToTipo(fd.get('especie') || ''),
                porte: fd.get('porte') || '',
                estado: fd.get('estado') || '',
                cidade: fd.get('cidade') || '',
                nome: fd.get('nome-pet') || ''
            };
            try{
                const data = await fetchAnimais(params);
                renderLista(data);
            }catch(err){
                console.error(err);
                renderLista([]);
            }
        }

        // Debounce para evitar requisi√ß√µes excessivas ao trocar filtros
        function debounce(fn, wait=300){
            let t; return function(...args){
                clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        const applyDebounced = debounce(applyFiltersFromForm, 250);

        form.addEventListener('submit', applyFiltersFromForm);
        form.querySelector('[name="especie"]').addEventListener('change', applyFiltersFromForm);
        form.querySelector('[name="porte"]').addEventListener('change', applyFiltersFromForm);
        cidadeSelect.addEventListener('change', applyFiltersFromForm);
        const nomeInput = form.querySelector('[name="nome-pet"]');
        nomeInput.addEventListener('input', applyDebounced);

        // Carregamento inicial: sem filtros (mostra dispon√≠veis)
        applyFiltersFromForm();
    })();
    
    // ===== SISTEMA DE CADASTRO DE PETS =====
    (function(){
        const btnCadastrar = document.getElementById('btn-cadastrar-pet');
        const modal = document.getElementById('modal-cadastrar-pet');
        const formCadastro = document.getElementById('form-cadastrar-pet');
        const estadoSelectModal = document.getElementById('pet-estado');
        const cidadeSelectModal = document.getElementById('pet-cidade');
        const especieSelect = document.getElementById('pet-especie');
        const grupoEspecieOutro = document.getElementById('grupo-especie-outro');
        const especieOutroInput = document.getElementById('pet-especie-outro');
        const corSelect = document.getElementById('pet-cor');
        const grupoCorOutro = document.getElementById('grupo-cor-outro');
        const corOutroInput = document.getElementById('pet-cor-outro');
        
        // Controle de campo "Outro" em esp√©cie
        if(especieSelect){
            especieSelect.addEventListener('change', function(){
                if(this.value === 'outro'){
                    grupoEspecieOutro.style.display = 'block';
                    especieOutroInput.setAttribute('required', 'required');
                }else{
                    grupoEspecieOutro.style.display = 'none';
                    especieOutroInput.removeAttribute('required');
                    especieOutroInput.value = '';
                }
            });
        }
        
        // Controle de campo "Outra cor"
        if(corSelect){
            corSelect.addEventListener('change', function(){
                if(this.value === 'Outro'){
                    grupoCorOutro.style.display = 'block';
                    corOutroInput.setAttribute('required', 'required');
                }else{
                    grupoCorOutro.style.display = 'none';
                    corOutroInput.removeAttribute('required');
                    corOutroInput.value = '';
                }
            });
        }
        
        // Popula estados no modal
        const UFS = ['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO'];
        UFS.forEach(uf => {
            const opt = document.createElement('option');
            opt.value = uf;
            opt.textContent = uf;
            estadoSelectModal.appendChild(opt);
        });
        
        // Carrega cidades quando estado √© selecionado
        if(estadoSelectModal){
            estadoSelectModal.addEventListener('change', async function(){
                const uf = this.value;
                cidadeSelectModal.disabled = true;
                cidadeSelectModal.innerHTML = '<option value="">Carregando...</option>';
                
                if(!uf){
                    cidadeSelectModal.innerHTML = '<option value="">Selecione o estado primeiro...</option>';
                    return;
                }
                
                const loadingIndicator = document.getElementById('loading-cidades');
                if(loadingIndicator) loadingIndicator.style.display = 'block';
                
                try{
                    const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`);
                    const cidades = await response.json();
                    
                    cidadeSelectModal.innerHTML = '<option value="">Selecione a cidade...</option>';
                    cidades.forEach(cidade => {
                        const opt = document.createElement('option');
                        opt.value = cidade.nome;
                        opt.textContent = cidade.nome;
                        cidadeSelectModal.appendChild(opt);
                    });
                    cidadeSelectModal.disabled = false;
                }catch(error){
                    console.error('Erro ao carregar cidades:', error);
                    cidadeSelectModal.innerHTML = '<option value="">Erro ao carregar cidades</option>';
                    alert('Erro ao carregar cidades. Tente novamente.');
                }finally{
                    if(loadingIndicator) loadingIndicator.style.display = 'none';
                }
            });
        }
        
        // Verifica se usu√°rio est√° logado (com refresh autom√°tico)
        async function checkUserLogado(){
            let token = localStorage.getItem('access');
            const refresh = localStorage.getItem('refresh');
            console.log('üîë Token encontrado:', !!token);
            
            if(!token){
                btnCadastrar.style.display = 'none';
                return false;
            }
            
            try{
                // Primeira tentativa com token atual
                let res = await fetch('http://localhost:8000/api/auth/me/', {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                console.log('‚úÖ Resposta auth/me (tentativa 1):', res.status);
                
                // Se 401 e tem refresh token, tenta renovar
                if(res.status === 401 && refresh){
                    console.log('üîÑ Token expirado, tentando renovar...');
                    try{
                        const refreshRes = await fetch('http://localhost:8000/api/auth/token/refresh/', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({refresh})
                        });
                        
                        if(refreshRes.ok){
                            const refreshData = await refreshRes.json();
                            token = refreshData.access;
                            localStorage.setItem('access', token);
                            console.log('‚úÖ Token renovado com sucesso!');
                            
                            // Tenta novamente com novo token
                            res = await fetch('http://localhost:8000/api/auth/me/', {
                                headers: {'Authorization': `Bearer ${token}`}
                            });
                            console.log('‚úÖ Resposta auth/me (tentativa 2):', res.status);
                        }else{
                            console.error('‚ùå Falha ao renovar token');
                            btnCadastrar.style.display = 'none';
                            return false;
                        }
                    }catch(refreshErr){
                        console.error('‚ùå Erro ao renovar token:', refreshErr);
                        btnCadastrar.style.display = 'none';
                        return false;
                    }
                }
                
                if(res.ok){
                    const userData = await res.json();
                    console.log('üë§ Usu√°rio logado:', userData.username || userData.email);
                    btnCadastrar.style.display = 'inline-flex';
                    return true;
                }else{
                    console.log('‚ùå Autentica√ß√£o falhou');
                    btnCadastrar.style.display = 'none';
                    return false;
                }
            }catch(e){
                console.error('üí• Erro ao verificar login:', e);
                btnCadastrar.style.display = 'none';
                return false;
            }
        }
        
        // Abre modal
        if(btnCadastrar){
            btnCadastrar.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('üêæ Bot√£o cadastrar clicado!');
                if(modal){
                    // Garantir que o modal seja completamente vis√≠vel
                    modal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 99999 !important; background: rgba(0, 0, 0, 0.7) !important; justify-content: center !important; align-items: center !important; backdrop-filter: blur(4px) !important; opacity: 1 !important; visibility: visible !important; pointer-events: auto !important;';
                    
                    // Previne scroll do body
                    document.body.style.overflow = 'hidden';
                    
                    const computedStyle = window.getComputedStyle(modal);
                    console.log('‚úÖ Modal configurado:', {
                        display: computedStyle.display,
                        opacity: computedStyle.opacity,
                        visibility: computedStyle.visibility,
                        zIndex: computedStyle.zIndex
                    });
                    
                    // Scroll para o topo
                    window.scrollTo(0, 0);
                    
                    console.log('‚úÖ Modal deve estar VIS√çVEL agora!');
                }else{
                    console.error('‚ùå Modal n√£o encontrado no DOM!');
                }
            });
            console.log('‚úÖ Event listener do bot√£o cadastrar adicionado');
        }else{
            console.error('‚ùå Bot√£o cadastrar n√£o encontrado no DOM!');
        }
        
        // Fecha modal
        window.fecharModalCadastro = function(){
            console.log('üö™ Fechando modal...');
            if(modal){
                modal.style.display = 'none';
                document.body.style.overflow = ''; // Restaura scroll do body
                if(formCadastro){
                    formCadastro.reset();
                }
                console.log('‚úÖ Modal fechado');
            }
        };
        
        // Fecha ao clicar fora
        if(modal){
            modal.addEventListener('click', (e) => {
                if(e.target === modal){
                    console.log('üëÜ Clique fora do modal detectado');
                    fecharModalCadastro();
                }
            });
        }
        
        // Submit do formul√°rio
        if(formCadastro){
            formCadastro.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('üìù Formul√°rio submetido!');
                
                let token = localStorage.getItem('access');
                const refresh = localStorage.getItem('refresh');
                
                if(!token){
                    alert('Voc√™ precisa estar logado para cadastrar um pet.');
                    window.location.href = '/login/';
                    return;
                }
                
                const formData = new FormData(formCadastro);
                console.log('üì¶ Dados do formul√°rio preparados');
                
                try{
                    console.log('üöÄ Enviando requisi√ß√£o para API...');
                    let res = await fetch('http://localhost:8000/api/animais-adocao/', {
                        method: 'POST',
                        headers: {'Authorization': `Bearer ${token}`},
                        body: formData
                    });
                    
                    console.log('üì° Resposta recebida:', res.status);
                    
                    // Se 401, tenta renovar token e reenviar
                    if(res.status === 401 && refresh){
                        console.log('üîÑ Token expirado, renovando e reenviando...');
                        try{
                            const refreshRes = await fetch('http://localhost:8000/api/auth/token/refresh/', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({refresh})
                            });
                            
                            if(refreshRes.ok){
                                const refreshData = await refreshRes.json();
                                token = refreshData.access;
                                localStorage.setItem('access', token);
                                console.log('‚úÖ Token renovado, reenviando formul√°rio...');
                                
                                // Reenviar com novo token
                                res = await fetch('http://localhost:8000/api/animais-adocao/', {
                                    method: 'POST',
                                    headers: {'Authorization': `Bearer ${token}`},
                                    body: formData
                                });
                                console.log('üì° Resposta ap√≥s renova√ß√£o:', res.status);
                            }
                        }catch(refreshErr){
                            console.error('‚ùå Erro ao renovar token:', refreshErr);
                            alert('Sua sess√£o expirou. Fa√ßa login novamente.');
                            window.location.href = '/login/';
                            return;
                        }
                    }
                    
                    if(!res.ok){
                        const error = await res.json();
                        console.error('‚ùå Erro da API:', error);
                        throw new Error(error.detail || 'Erro ao cadastrar pet');
                    }
                    
                    const data = await res.json();
                    console.log('‚úÖ Pet cadastrado:', data);
                    alert('Pet cadastrado com sucesso! Aguarde a aprova√ß√£o do administrador para que ele apare√ßa na galeria.');
                    fecharModalCadastro();
                    
                    // Recarrega a galeria (caso o pet seja aprovado automaticamente ou j√° tenha outros pets)
                    location.reload();
                }catch(err){
                    console.error('üí• Erro ao cadastrar:', err);
                    alert('Erro ao cadastrar pet: ' + err.message);
                }
            });
            console.log('‚úÖ Event listener de submit adicionado');
        }else{
            console.error('‚ùå Formul√°rio de cadastro n√£o encontrado no DOM!');
        }
        
        // Verifica login ao carregar
        checkUserLogado();
    })();
    
    // ===== MODAL DE DETALHES DO PET =====
    async function abrirModalDetalhes(petId, origem){
        console.log('üêæ Abrindo modal para pet:', petId, 'origem:', origem);
        const modal = document.getElementById('modal-detalhes-pet');
        const conteudo = document.getElementById('conteudo-modal-pet');
        
        try {
            // Busca dados completos do pet
            const response = await fetch(`http://localhost:8000/api/animais-adocao/${petId}/`);
            if(!response.ok) throw new Error('Erro ao buscar dados do pet');
            
            const pet = await response.json();
            console.log('‚úÖ Dados do pet:', pet);
            
            // Renderiza o conte√∫do do modal
            conteudo.innerHTML = `
                <div class="pet-modal-grid">
                    <div class="pet-modal-imagem">
                        <img src="${pet.imagem_principal_url || 'https://placehold.co/600x600?text=Sem+Foto'}" alt="${pet.nome}">
                    </div>
                    <div class="pet-modal-info">
                        <h2 class="pet-modal-nome"><i class="fas fa-paw"></i> ${pet.nome}</h2>
                        <div class="pet-modal-badges">
                            <span class="badge badge-especie">${pet.especie_display}</span>
                            <span class="badge badge-porte">${pet.porte_display}</span>
                            ${pet.sexo ? `<span class="badge badge-sexo">${pet.sexo === 'macho' ? '‚ôÇ Macho' : '‚ôÄ F√™mea'}</span>` : ''}
                        </div>
                        
                        <div class="pet-modal-secao">
                            <h3><i class="fas fa-align-left"></i> Sobre ${pet.nome}</h3>
                            <p>${pet.descricao}</p>
                        </div>
                        
                        <div class="pet-modal-secao">
                            <h3><i class="fas fa-map-marker-alt"></i> Localiza√ß√£o</h3>
                            <p><strong>Cidade:</strong> ${pet.cidade}, ${pet.estado}</p>
                        </div>
                        
                        <div class="pet-modal-acoes">
                            <button onclick="manifestarInteresse(${pet.id}, '${pet.nome}')" class="btn-interesse">
                                <i class="fas fa-heart"></i> Tenho Interesse em Adotar
                            </button>
                        </div>
                        
                        <div class="pet-modal-aviso-box">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Como funciona?</strong>
                                <p>Ao manifestar interesse, sua solicita√ß√£o ser√° enviada para aprova√ß√£o. Ap√≥s aprovada, voc√™ receber√° uma notifica√ß√£o com os dados de contato do doador!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Mostra o modal
            modal.style.cssText = 'display: flex !important; opacity: 1 !important; visibility: visible !important;';
            document.body.style.overflow = 'hidden';
            
        } catch(error) {
            console.error('‚ùå Erro ao abrir modal:', error);
            alert('Erro ao carregar dados do pet. Tente novamente.');
        }
    }
    
    function fecharModalDetalhes(){
        const modal = document.getElementById('modal-detalhes-pet');
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
    
    async function manifestarInteresse(petId, petNome){
        const token = localStorage.getItem('access');
        
        if(!token){
            alert('Voc√™ precisa estar logado para manifestar interesse em adotar!');
            window.location.href = '/login/';
            return;
        }
        
        // Pergunta se o usu√°rio quer adicionar uma mensagem
        const mensagem = prompt(`Deseja adicionar uma mensagem para o doador de ${petNome}? (Opcional)`);
        
        if(mensagem === null) return; // Cancelou
        
        try {
            const response = await fetch('http://localhost:8000/api/solicitacoes-adocao/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    animal: petId,
                    mensagem: mensagem || ''
                })
            });
            
            if(response.status === 400){
                const error = await response.json();
                if(error.non_field_errors && error.non_field_errors[0].includes('j√° existe')){
                    alert('Voc√™ j√° manifestou interesse neste pet! Aguarde a aprova√ß√£o do administrador.');
                } else {
                    alert('Erro ao enviar solicita√ß√£o. Verifique os dados e tente novamente.');
                }
                return;
            }
            
            if(!response.ok) throw new Error('Erro ao enviar solicita√ß√£o');
            
            alert(`‚úÖ Solicita√ß√£o enviada com sucesso!\n\nSua manifesta√ß√£o de interesse em adotar ${petNome} foi enviada para aprova√ß√£o. Voc√™ receber√° uma notifica√ß√£o quando for aprovada, com os dados de contato do doador.`);
            fecharModalDetalhes();
            
        } catch(error) {
            console.error('Erro ao manifestar interesse:', error);
            alert('Erro ao enviar solicita√ß√£o. Tente novamente.');
        }
    }
    
    // Fecha modal ao clicar fora
    document.getElementById('modal-detalhes-pet')?.addEventListener('click', (e) => {
        if(e.target.id === 'modal-detalhes-pet'){
            fecharModalDetalhes();
        }
    });
    </script>
    <script src="{% static 'user_session.js' %}" defer></script>
</body>
</html>